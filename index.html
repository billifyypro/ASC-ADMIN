<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASC JEWELLERS • Admin Console</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #111;
            --gold: #D4AF37;
            --bg: #f4f6f8;
            --white: #fff;
            --border: #e0e0e0;
            --sidebar-w: 260px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Lato', sans-serif; }
        body { background: var(--bg); display: flex; height: 100vh; overflow: hidden; color: var(--primary); }
        h1, h2, h3, .serif { font-family: 'Playfair Display', serif; }

        /* Sidebar */
        aside { width: var(--sidebar-w); background: var(--primary); color: white; display: flex; flex-direction: column; flex-shrink: 0; transition: 0.3s; }
        .brand { font-size: 24px; padding: 30px; text-align: center; color: var(--gold); border-bottom: 1px solid #333; letter-spacing: 2px; }
        .nav-links { padding: 20px 0; flex: 1; overflow-y: auto; }
        .nav-item { padding: 15px 30px; cursor: pointer; color: #aaa; transition: 0.3s; display: flex; align-items: center; gap: 15px; position: relative; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.05); color: var(--gold); border-left: 4px solid var(--gold); }
        .nav-item i { width: 20px; text-align: center; }
        
        /* Notification Dot */
        .notification-dot { width: 8px; height: 8px; background-color: #ff4444; border-radius: 50%; position: absolute; right: 20px; top: 50%; transform: translateY(-50%); display: none; box-shadow: 0 0 5px #ff4444; }
        .notification-dot.visible { display: block; }

        /* Main Content */
        main { flex: 1; overflow-y: auto; padding: 30px; position: relative; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px; }
        .title { font-size: 2rem; }

        /* Cards & Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--white); border-radius: 8px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .stat-val { font-size: 2rem; font-weight: bold; margin-top: 10px; color: var(--primary); }
        .stat-label { color: #666; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }

        /* Rate Management */
        .rate-card { background: var(--primary); color: white; }
        .rate-input-group { display: flex; gap: 15px; margin-top: 15px; flex-wrap: wrap; }
        .rate-input { background: rgba(255,255,255,0.1); border: 1px solid #444; color: white; padding: 10px; border-radius: 4px; flex: 1; min-width: 120px; outline: none; }
        .rate-input:focus { border-color: var(--gold); }
        .btn-gold { background: var(--gold); color: black; border: none; padding: 10px 20px; font-weight: bold; border-radius: 4px; cursor: pointer; white-space: nowrap; }
        
        /* Stats Control */
        .stats-control-group { display: flex; gap: 10px; margin-top: 10px; align-items: center; }

        /* Tables */
        .table-wrap { background: var(--white); border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { padding: 15px 20px; text-align: left; border-bottom: 1px solid var(--border); vertical-align: top;}
        th { background: #f9fafb; font-weight: 600; color: #555; }
        /* FIX: Admin Image Preview */
        td img { width: 40px; height: 40px; border-radius: 4px; object-fit: cover; }
        
        /* Buttons */
        .btn-action { padding: 6px 10px; border-radius: 4px; border: none; cursor: pointer; font-size: 0.9rem; margin-right: 5px; }
        .btn-edit { background: #e3f2fd; color: #1976d2; }
        .btn-del { background: #ffebee; color: #d32f2f; }
        .btn-review { background: #fff8e1; color: #f57f17; }
        .btn-add { background: var(--primary); color: white; padding: 10px 20px; border-radius: 4px; cursor: pointer; border: none; }
        .btn-reset { background: #333; color: #fff; font-size: 0.7rem; padding: 5px 10px; border-radius: 4px; border: none; cursor: pointer; margin-left: 10px; }
        .btn-reset:hover { background: #555; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; }

        /* Modal */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; width: 90%; max-width: 500px; padding: 30px; border-radius: 8px; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; outline: none; }
        .row { display: flex; gap: 15px; }
        
        /* Multiple Image Inputs */
        .img-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .img-row button { background: #eee; border: none; cursor: pointer; pxadding: 0 10px; color: #333; }
        
        /* Status Badges */
        .badge { padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: bold; display: inline-block; min-width: 80px; text-align: center; }
        .st-Pending { background: #fff3cd; color: #856404; }
        .st-Confirmed { background: #d4edda; color: #155724; }
        .st-Packed { background: #d1ecf1; color: #0c5460; }
        .st-Shipped { background: #cce5ff; color: #004085; }
        .st-Delivered { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .st-Cancelled { background: #f8d7da; color: #721c24; }

        /* Settings & Coupons */
        .settings-section { margin-bottom: 30px; padding-bottom: 30px; border-bottom: 1px solid var(--border); }
        .coupon-list { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .coupon-tag { background: #f0f0f0; border: 1px solid #ddd; padding: 8px 15px; border-radius: 20px; display: flex; align-items: center; gap: 10px; }
        .coupon-tag i { cursor: pointer; color: #d32f2f; }

        /* TRACKING & BUCKET STYLES */
        .track-result-box { margin-top: 20px; padding: 20px; background: #f9f9f9; border-radius: 8px; border: 1px solid #eee; display: none; }
        .track-row { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px dashed #ddd; padding-bottom: 10px; }
        .track-row:last-child { border: none; margin: 0; padding: 0; }
        
        .bucket-container { margin-top: 20px; display: none; }
        .bucket-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
        .bucket-item { background: white; border: 1px solid #eee; border-radius: 6px; padding: 10px; }
        
        /* IMAGE GLITCH FIX APPLIED HERE */
        .bucket-img { 
            width: 100%; 
            height: 120px; 
            object-fit: contain; /* FIX: No cover */
            background-color: #f5f5f5;
            mix-blend-mode: normal; /* FIX: No multiply */
            border-radius: 4px;
            margin-bottom: 10px;
        }

        /* Toast */
        #toast { position: fixed; bottom: 30px; right: 30px; background: var(--primary); color: var(--gold); padding: 15px 25px; border-radius: 4px; opacity: 0; transition: 0.3s; pointer-events: none; }
        #toast.show { opacity: 1; bottom: 50px; }

        .hidden { display: none; }
        .mobile-menu-btn { display: none; font-size: 24px; cursor: pointer; padding: 10px; }

        @media (max-width: 900px) {
            body { flex-direction: column; overflow: auto; }
            aside { width: 100%; height: auto; display: none; }
            aside.active { display: block; }
            .mobile-menu-btn { display: block; }
            .nav-links { display: flex; flex-direction: column; }
            .stats-grid { grid-template-columns: 1fr; }
            .row { flex-direction: column; gap: 0; }
        }
    </style>
</head>
<body>

    <aside id="sidebar">
        <div class="brand serif">ASC ADMIN</div>
        <div class="nav-links">
            <div class="nav-item active" onclick="switchView('dash')">
                <i class="fas fa-chart-pie"></i> Dashboard
            </div>
            <div class="nav-item" onclick="switchView('tracking')">
                <i class="fas fa-search-location"></i> Track Order
            </div>
            <div class="nav-item" onclick="switchView('products')">
                <i class="fas fa-gem"></i> Products
            </div>
            <div class="nav-item" onclick="switchView('categories')">
                <i class="fas fa-tags"></i> Categories
            </div>
            <div class="nav-item" onclick="switchView('orders')">
                <i class="fas fa-shopping-basket"></i> Orders
                <span id="orders-dot" class="notification-dot"></span>
            </div>
            <div class="nav-item" onclick="switchView('users')">
                <i class="fas fa-users"></i> Users
            </div>
            <div class="nav-item" onclick="switchView('settings')">
                <i class="fas fa-cogs"></i> Settings
            </div>
        </div>
    </aside>

    <main>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <i class="fas fa-bars mobile-menu-btn" onclick="toggleSidebar()"></i>
        </div>

        <div id="view-dash">
            <div class="header">
                <h2 class="title serif">Dashboard Overview</h2>
            </div>

            <div class="stats-grid">
                <div class="card rate-card" style="grid-column: 1 / -1;">
                    <div class="stat-label" style="color:var(--gold);">Live Rates & Counters</div>
                    <div class="rate-input-group">
                        <input type="number" id="rate-gold" class="rate-input" placeholder="Gold Rate">
                        <input type="number" id="rate-silver" class="rate-input" placeholder="Silver Rate">
                        <input type="number" id="rate-italian" class="rate-input" placeholder="Italian Silver Rate">
                        <button class="btn-gold" onclick="updateRates()">UPDATE RATES</button>
                    </div>
                    <div style="margin-top: 15px; padding-top:15px; border-top: 1px solid #444;">
                         <div class="stat-label" style="color:#aaa; font-size:0.75rem;">Completed Orders (Manual Override)</div>
                         <div class="stats-control-group">
                            <input type="number" id="manual-orders-count" class="rate-input" placeholder="Ex: 5000" style="background:white; color:black;">
                            <button class="btn-gold" style="padding: 8px 15px;" onclick="saveManualCount()">SAVE COUNT</button>
                         </div>
                    </div>
                </div>
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div class="stat-label">Total Revenue</div>
                        <button class="btn-reset" onclick="resetRevenue()" title="Reset display to 0 without deleting orders">RESET</button>
                    </div>
                    <div class="stat-val" id="st-rev">₹0</div>
                </div>
                <div class="card">
                    <div class="stat-label">Total Orders</div>
                    <div class="stat-val" id="st-ord">0</div>
                </div>
            </div>

            <div class="card">
                <h3 class="serif" style="margin-bottom: 20px;">Recent Orders</h3>
                <div class="table-wrap">
                    <table id="dash-orders-table">
                        <thead><tr><th>Order ID</th><th>Customer</th><th>Amount</th><th>Status</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-tracking" class="hidden">
            <div class="header">
                <h2 class="title serif">Track Order</h2>
            </div>
            <div class="card" style="max-width: 800px;">
                <div class="form-group">
                    <label class="form-label">Enter Order ID</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="track-id-input" class="form-control" placeholder="e.g. ORD-ASC-2025-0001">
                        <button class="btn-add" onclick="trackOrder()">Track</button>
                    </div>
                </div>

                <div id="track-result" class="track-result-box">
                    <div id="track-details"></div>
                    <button class="btn-add" style="margin-top: 20px; width: 100%;" onclick="loadBucket()">Load Bucket (View Products)</button>
                    
                    <div id="bucket-container" class="bucket-container">
                        <h4 class="serif" style="margin-bottom:10px; border-bottom:1px solid #ddd; padding-bottom:5px;">Bucket Products (Pending)</h4>
                        <div id="bucket-grid" class="bucket-grid"></div>
                    </div>
                </div>
                <div id="track-error" style="color: red; margin-top: 10px; display: none;">Order not found. Please check ID.</div>
            </div>
        </div>

        <div id="view-products" class="hidden">
            <div class="header">
                <h2 class="title serif">Product Management</h2>
                <button class="btn-add" onclick="openProductModal()">+ Add Product</button>
            </div>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr><th>Img</th><th>Name</th><th>Cat</th><th>Metal</th><th>Wt</th><th>Mk Chg</th><th>Actions</th></tr>
                    </thead>
                    <tbody id="products-table"></tbody>
                </table>
            </div>
        </div>

        <div id="view-categories" class="hidden">
            <div class="header">
                <h2 class="title serif">Categories</h2>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
                <div class="card">
                    <h3 class="serif" style="margin-bottom: 15px;">Add Category</h3>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="new-cat-name" class="form-control" placeholder="Category Name">
                        <button class="btn-add" onclick="addCategory()">Add</button>
                    </div>
                </div>
                <div class="card">
                    <h3 class="serif" style="margin-bottom: 15px;">Existing Categories</h3>
                    <div id="cat-list" style="display:flex; flex-wrap:wrap; gap:10px;"></div>
                </div>
            </div>
        </div>

        <div id="view-orders" class="hidden">
            <div class="header">
                <h2 class="title serif">All Orders</h2>
            </div>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>Order #</th>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>Item Details (Name | Cat | Qty)</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="orders-table"></tbody>
                </table>
            </div>
        </div>

        <div id="view-users" class="hidden">
            <div class="header">
                <h2 class="title serif">Registered Users</h2>
            </div>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Joined</th>
                            <th>Saved Address</th>
                        </tr>
                    </thead>
                    <tbody id="users-table"></tbody>
                </table>
            </div>
        </div>

        <div id="view-settings" class="hidden">
            <div class="header">
                <h2 class="title serif">Settings & Coupons</h2>
            </div>

            <div class="card settings-section">
                <h3 class="serif" style="margin-bottom:15px;">Delivery Charges</h3>
                <div class="row" style="align-items: flex-end;">
                    <div class="form-group" style="flex:1;">
                        <label class="form-label">Global Delivery Charge (₹)</label>
                        <input type="number" id="setting-delivery" class="form-control" placeholder="0">
                    </div>
                    <button class="btn-add" onclick="saveDeliveryCharge()" style="height:42px; margin-bottom:15px;">Save Charge</button>
                </div>
            </div>

            <div class="card">
                <h3 class="serif" style="margin-bottom:15px;">Discount Coupons</h3>
                <div class="row">
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Code</label>
                        <input type="text" id="cp-code" class="form-control" placeholder="e.g. SAVE10">
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Type</label>
                        <select id="cp-type" class="form-control">
                            <option value="flat">Flat Amount (₹)</option>
                            <option value="percent">Percentage (%)</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Value</label>
                        <input type="number" id="cp-value" class="form-control" placeholder="100 or 10">
                    </div>
                </div>
                <div class="row">
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Min Order (₹)</label>
                        <input type="number" id="cp-min" class="form-control" placeholder="0">
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Expiry Date</label>
                        <input type="date" id="cp-expiry" class="form-control">
                    </div>
                    <button class="btn-add" onclick="addCoupon()" style="height:42px; margin-top:22px;">Create Coupon</button>
                </div>

                <div class="coupon-list" id="active-coupons">
                    </div>
            </div>
        </div>
    </main>

    <div id="product-modal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3 class="serif" id="modal-title">Add Product</h3>
                <i class="fas fa-times" onclick="closeModal('product-modal')" style="cursor:pointer;"></i>
            </div>
            <form onsubmit="saveProduct(event)">
                <input type="hidden" id="p-id">
                <div class="form-group">
                    <label class="form-label">Product Name</label>
                    <input type="text" id="p-name" class="form-control" required>
                </div>
                <div class="row">
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Category</label>
                        <select id="p-cat" class="form-control"></select>
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Metal</label>
                        <select id="p-metal" class="form-control">
                            <option value="gold">Gold</option>
                            <option value="silver">Silver</option>
                            <option value="italian">Italian Silver</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Karat</label>
                        <select id="p-karat" class="form-control">
                            <option value="24K">24K</option>
                            <option value="22K">22K</option>
                            <option value="18K">18K</option>
                            <option value="14K">14K</option>
                            <option value="925">925</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Weight (grams)</label>
                        <input type="number" step="0.01" id="p-weight" class="form-control" required>
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Making Charge (₹)</label>
                        <input type="number" id="p-making" class="form-control" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Image URLs (Must start with https://)</label>
                    <div id="p-imgs-container"></div>
                    <button type="button" class="btn-sm btn-add" style="margin-top:5px; background:#eee; color:#333;" onclick="addImageInput()">+ Add Image</button>
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="p-desc" class="form-control" rows="3"></textarea>
                </div>
                <button type="submit" class="btn-add" style="width:100%;">Save Product</button>
            </form>
        </div>
    </div>

    <div id="review-modal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3 class="serif">Add Manual Review</h3>
                <i class="fas fa-times" onclick="closeModal('review-modal')" style="cursor:pointer;"></i>
            </div>
            <input type="hidden" id="rev-pid">
            <div class="form-group">
                <label class="form-label">Customer Name</label>
                <input type="text" id="rev-name" class="form-control" placeholder="e.g. John Doe">
            </div>
            <div class="form-group">
                <label class="form-label">Star Rating (1-5)</label>
                <select id="rev-stars" class="form-control">
                    <option value="5">★★★★★ (5)</option>
                    <option value="4">★★★★ (4)</option>
                    <option value="3">★★★ (3)</option>
                    <option value="2">★★ (2)</option>
                    <option value="1">★ (1)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Remark</label>
                <textarea id="rev-remark" class="form-control" rows="3" placeholder="Excellent product..."></textarea>
            </div>
            <button class="btn-add" style="width:100%;" onclick="saveFakeReview()">Add Review</button>
        </div>
    </div>

    <div id="toast">Action Successful</div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCJTI3q7yLPjF_3Hg0MvRJEuTOt02xV7fs",
            authDomain: "invoice-maker-a31e6.firebaseapp.com",
            databaseURL: "https://invoice-maker-a31e6-default-rtdb.firebaseio.com",
            projectId: "invoice-maker-a31e6",
            storageBucket: "invoice-maker-a31e6.firebasestorage.app",
            messagingSenderId: "84503037388",
            appId: "1:84503037388:web:0e4d89f4347376581e0969"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let products = [];
        let categories = [];
        let orders = [];
        let revenueOffset = 0;
        let activeView = 'dash';
        let foundOrderData = null; // Stores currently tracked order

        // INIT
        document.addEventListener("DOMContentLoaded", () => {
            fetchRates();
            fetchProducts(); 
            fetchCategories();
            fetchOrders();
            fetchUsers();
            fetchSettings();
            fetchStatsConfig();
        });

        // --- SIDEBAR & NOTIFICATIONS ---
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }
        
        function updateOrderNotification() {
            const hasPending = orders.some(o => o.status !== 'Delivered');
            const dot = document.getElementById('orders-dot');
            if (hasPending && activeView !== 'orders') {
                dot.classList.add('visible');
            } else {
                dot.classList.remove('visible');
            }
        }

        // --- TRACKING & BUCKET LOGIC (NEW) ---
        async function trackOrder() {
            const id = document.getElementById('track-id-input').value.trim();
            const resultBox = document.getElementById('track-result');
            const errorBox = document.getElementById('track-error');
            const bucketContainer = document.getElementById('bucket-container');

            // Reset UI
            resultBox.style.display = 'none';
            errorBox.style.display = 'none';
            bucketContainer.style.display = 'none';
            foundOrderData = null;

            if(!id) return;

            // Query by string orderId (not doc id)
            const snap = await db.collection('orders').where('orderId', '==', id).get();
            
            if(snap.empty) {
                errorBox.style.display = 'block';
            } else {
                const data = snap.docs[0].data();
                foundOrderData = data;
                
                const dateStr = data.createdAt ? data.createdAt.toDate().toLocaleDateString() : 'N/A';
                const customer = data.customerDetails || {};

                document.getElementById('track-details').innerHTML = `
                    <div class="track-row"><span>Order ID</span> <b>${data.orderId}</b></div>
                    <div class="track-row"><span>Customer Name</span> <b>${customer.name || 'N/A'}</b></div>
                    <div class="track-row"><span>Mobile</span> <b>${customer.phone || 'N/A'}</b></div>
                    <div class="track-row"><span>Full Address</span> <span style="text-align:right; font-size:0.9rem;">${customer.address || 'N/A'}</span></div>
                    <div class="track-row"><span>Order Date</span> <b>${dateStr}</b></div>
                    <div class="track-row"><span>Status</span> <span class="badge st-${data.status}">${data.status}</span></div>
                `;
                resultBox.style.display = 'block';
            }
        }

        function loadBucket() {
            if(!foundOrderData) return;
            const container = document.getElementById('bucket-container');
            const grid = document.getElementById('bucket-grid');
            
            grid.innerHTML = foundOrderData.items.map(item => `
                <div class="bucket-item">
                    <img src="${item.image || 'https://via.placeholder.com/150'}" class="bucket-img" loading="lazy" decoding="async">
                    <div style="font-weight:bold; font-size:0.9rem; margin-bottom:5px;">${item.name}</div>
                    <div style="font-size:0.8rem; color:#666; margin-bottom:5px;">${item.description || 'No description'}</div>
                    <span class="badge st-${foundOrderData.status}" style="font-size:0.7rem;">${foundOrderData.status}</span>
                </div>
            `).join('');

            container.style.display = 'block';
        }

        // --- RATES & STATS ---
        function fetchRates() {
            db.collection('rates').doc('current').onSnapshot(doc => {
                if(doc.exists) {
                    const data = doc.data();
                    document.getElementById('rate-gold').value = data.gold;
                    document.getElementById('rate-silver').value = data.silver;
                    document.getElementById('rate-italian').value = data.italian || '';
                }
            });
        }
        
        function fetchStatsConfig() {
            db.collection('config').doc('stats').onSnapshot(doc => {
                if(doc.exists) {
                    const data = doc.data();
                    revenueOffset = data.revenueOffset || 0;
                    document.getElementById('manual-orders-count').value = data.manualOrderCount || '';
                    updateStats(); 
                }
            });
        }

        async function updateRates() {
            const gold = parseFloat(document.getElementById('rate-gold').value);
            const silver = parseFloat(document.getElementById('rate-silver').value);
            const italian = parseFloat(document.getElementById('rate-italian').value);
            await db.collection('rates').doc('current').set({ gold, silver, italian }, { merge: true });
            showToast('Rates Updated');
        }

        async function saveManualCount() {
            const count = parseInt(document.getElementById('manual-orders-count').value);
            if(isNaN(count)) return;
            await db.collection('config').doc('stats').set({ manualOrderCount: count }, { merge: true });
            showToast('Manual Order Count Saved');
        }
        
        async function resetRevenue() {
            const currentTotalRev = orders.filter(o => o.status !== 'Cancelled').reduce((acc, o) => acc + (o.total || 0), 0);
            if(confirm("Are you sure? This will set displayed revenue to 0. No data will be deleted.")) {
                 await db.collection('config').doc('stats').set({ revenueOffset: currentTotalRev }, { merge: true });
                 showToast('Revenue Display Reset');
            }
        }

        // --- CATEGORIES ---
        function fetchCategories() {
            db.collection('categories').onSnapshot(snap => {
                categories = snap.docs.map(d => ({id: d.id, ...d.data()}));
                document.getElementById('cat-list').innerHTML = categories.map(c => 
                    `<span class="coupon-tag">${c.name} <i class="fas fa-times" onclick="deleteCategory('${c.id}')"></i></span>`
                ).join('');
                document.getElementById('p-cat').innerHTML = categories.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            });
        }
        async function addCategory() {
            const name = document.getElementById('new-cat-name').value;
            if(!name) return;
            await db.collection('categories').add({ name });
            document.getElementById('new-cat-name').value = '';
            showToast('Category Added');
        }
        async function deleteCategory(id) {
            if(confirm("Delete category?")) await db.collection('categories').doc(id).delete();
        }

        // --- PRODUCTS ---
        function fetchProducts() {
            db.collection('products').onSnapshot(snap => {
                products = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderProductTable();
                if(orders.length > 0) renderOrders(); 
            });
        }
        function renderProductTable() {
            document.getElementById('products-table').innerHTML = products.map(p => {
                const mainImg = (p.images && p.images.length > 0) ? p.images[0] : p.image;
                return `
                <tr>
                    <td><img src="${mainImg}"></td>
                    <td><b>${p.name}</b></td>
                    <td>${p.category}</td>
                    <td>${p.metal}</td>
                    <td>${p.weight}g</td>
                    <td>₹${p.makingCharge}</td>
                    <td>
                        <button class="btn-action btn-edit" onclick="openProductModal('${p.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn-action btn-del" onclick="deleteProduct('${p.id}')"><i class="fas fa-trash"></i></button>
                        <button class="btn-action btn-review" onclick="openReviewModal('${p.id}')"><i class="fas fa-star"></i></button>
                    </td>
                </tr>
            `}).join('');
        }
        
        function addImageInput(value = '') {
            const container = document.getElementById('p-imgs-container');
            const div = document.createElement('div');
            div.className = 'img-row';
            div.innerHTML = `
                <input type="url" class="form-control p-img-input" value="${value}" placeholder="Image URL (https://...)" required>
                <button type="button" onclick="this.parentElement.remove()">X</button>
            `;
            container.appendChild(div);
        }

        function openProductModal(id = null) {
            const modal = document.getElementById('product-modal');
            const title = document.getElementById('modal-title');
            document.querySelector('form').reset();
            const imgContainer = document.getElementById('p-imgs-container');
            imgContainer.innerHTML = ''; 

            if(id) {
                const p = products.find(x => x.id === id);
                document.getElementById('p-id').value = p.id;
                document.getElementById('p-name').value = p.name;
                document.getElementById('p-cat').value = p.category;
                document.getElementById('p-metal').value = p.metal;
                document.getElementById('p-karat').value = p.karat || '22K';
                document.getElementById('p-weight').value = p.weight;
                document.getElementById('p-making').value = p.makingCharge;
                document.getElementById('p-desc').value = p.description || '';
                
                if(p.images && p.images.length > 0) {
                    p.images.forEach(url => addImageInput(url));
                } else if (p.image) {
                    addImageInput(p.image);
                } else {
                    addImageInput();
                }

                title.innerText = "Edit Product";
            } else {
                document.getElementById('p-id').value = '';
                addImageInput(); 
                title.innerText = "Add Product";
            }
            modal.classList.add('active');
        }

        async function saveProduct(e) {
            e.preventDefault();
            const id = document.getElementById('p-id').value;
            
            // Collect images
            const imgInputs = document.querySelectorAll('.p-img-input');
            const images = [];
            let hasError = false;

            imgInputs.forEach(i => {
                const val = i.value.trim();
                // IMAGE VALIDATION: CHECK HTTPS
                if(val) {
                    if(!val.startsWith('https://')) {
                        hasError = true;
                    } else {
                        images.push(val);
                    }
                }
            });

            if(hasError) {
                alert("Only https:// image URLs are allowed.");
                return;
            }

            const data = {
                name: document.getElementById('p-name').value,
                category: document.getElementById('p-cat').value,
                metal: document.getElementById('p-metal').value,
                karat: document.getElementById('p-karat').value,
                weight: parseFloat(document.getElementById('p-weight').value),
                makingCharge: parseFloat(document.getElementById('p-making').value),
                images: images, 
                image: images.length > 0 ? images[0] : '', 
                description: document.getElementById('p-desc').value,
                updatedAt: new Date()
            };
            
            if(id) await db.collection('products').doc(id).update(data);
            else await db.collection('products').add(data);
            
            closeModal('product-modal');
            showToast('Product Saved');
        }

        async function deleteProduct(id) {
            if(confirm("Delete product?")) await db.collection('products').doc(id).delete();
        }

        // --- FAKE REVIEWS ---
        function openReviewModal(pid) {
            document.getElementById('rev-pid').value = pid;
            document.getElementById('rev-name').value = '';
            document.getElementById('rev-stars').value = '5';
            document.getElementById('rev-remark').value = '';
            document.getElementById('review-modal').classList.add('active');
        }

        async function saveFakeReview() {
            const pid = document.getElementById('rev-pid').value;
            const name = document.getElementById('rev-name').value || "Verified Customer";
            const stars = parseInt(document.getElementById('rev-stars').value);
            const remark = document.getElementById('rev-remark').value;

            if(!pid) return;

            const reviewData = {
                productId: pid,
                userId: 'admin_fake_' + Date.now(),
                userName: name,
                stars: stars,
                remark: remark,
                isFake: true,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            await db.collection('ratings').add(reviewData);
            closeModal('review-modal');
            showToast('Review Added Successfully');
        }

        // --- ORDERS ---
        function fetchOrders() {
            db.collection('orders').orderBy('createdAt', 'desc').onSnapshot(snap => {
                orders = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderOrders();
                updateStats();
                updateOrderNotification();
            });
        }
        
        function renderOrders() {
            const getRow = (o) => {
                const details = o.items.map(item => {
                    const productRef = products.find(p => p.id === item.id);
                    const cat = productRef ? productRef.category : '';
                    return `<div style="font-size:0.9rem; margin-bottom:4px;">
                              <b>${item.name}</b> ${cat ? `(${cat})` : ''} 
                              <span style="color:#666">x${item.qty}</span>
                            </div>`;
                }).join('');

                // Display custom generated Order ID instead of Doc ID
                const displayId = o.orderId || o.id.slice(0,6).toUpperCase();

                return `
                <tr>
                    <td>#${displayId}</td>
                    <td>${o.createdAt ? o.createdAt.toDate().toLocaleDateString() : '-'}</td>
                    <td>${o.customerDetails?.name || o.userName}<br><span style="font-size:0.8rem; color:#888;">${o.customerDetails?.phone || o.userPhone}</span></td>
                    <td>${details}</td>
                    <td>
                        <div style="font-size:0.9rem">Sub: ₹${o.subtotal?.toFixed(2) || 0}</div>
                        <div style="font-size:0.9rem">Del: +₹${o.deliveryCharge || 0}</div>
                        ${o.discount ? `<div style="font-size:0.9rem; color:green;">Disc: -₹${o.discount.toFixed(2)}</div>` : ''}
                        <div style="font-weight:bold;">Total: ₹${o.total.toFixed(2)}</div>
                    </td>
                    <td><span class="badge st-${o.status}">${o.status}</span></td>
                    <td>
                        <select onchange="updateStatus('${o.id}', this.value)" style="padding:5px; border-radius:4px;">
                            <option value="">Update...</option>
                            <option value="Confirmed" ${o.status==='Confirmed'?'selected':''}>Confirm</option>
                            <option value="Packed" ${o.status==='Packed'?'selected':''}>Pack</option>
                            <option value="Shipped" ${o.status==='Shipped'?'selected':''}>Ship</option>
                            <option value="Delivered" ${o.status==='Delivered'?'selected':''}>Deliver</option>
                            <option value="Cancelled" ${o.status==='Cancelled'?'selected':''}>Cancel</option>
                        </select>
                    </td>
                </tr>`;
            };

            document.getElementById('orders-table').innerHTML = orders.map(getRow).join('');
            document.getElementById('dash-orders-table').querySelector('tbody').innerHTML = orders.slice(0,5).map(o => `
                <tr>
                    <td>#${o.orderId || o.id.slice(0,6)}</td>
                    <td>${o.customerDetails?.name || 'User'}</td>
                    <td>₹${o.total.toFixed(2)}</td>
                    <td><span class="badge st-${o.status}">${o.status}</span></td>
                </tr>
            `).join('');
        }
        
        async function updateStatus(oid, status) {
            if(!status) return;
            await db.collection('orders').doc(oid).update({ status });
            showToast(`Status updated to ${status}`);
        }
        
        function updateStats() {
            const realRevenue = orders.filter(o => o.status !== 'Cancelled').reduce((acc, o) => acc + (o.total || 0), 0);
            let displayRevenue = realRevenue - revenueOffset;
            if (displayRevenue < 0) displayRevenue = 0;

            document.getElementById('st-rev').innerText = '₹' + displayRevenue.toLocaleString('en-IN');
            document.getElementById('st-ord').innerText = orders.length;
        }

        // --- USERS ---
        function fetchUsers() {
            db.collection('users').onSnapshot(snap => {
                const users = snap.docs.map(d => d.data());
                document.getElementById('users-table').innerHTML = users.map(u => `
                    <tr>
                        <td>${u.name || '-'}</td>
                        <td>${u.email}</td>
                        <td>${u.phone || '-'}</td>
                        <td>${u.createdAt ? u.createdAt.toDate().toLocaleDateString() : '-'}</td>
                        <td>
                            ${u.deliveryDetails ? 
                            `<div style="font-size:0.8rem;">${u.deliveryDetails.address}, ${u.deliveryDetails.pincode}</div>` 
                            : '<span style="color:#aaa">No saved address</span>'}
                        </td>
                    </tr>
                `).join('');
            });
        }

        // --- SETTINGS & COUPONS ---
        function fetchSettings() {
            db.collection('config').doc('store').onSnapshot(doc => {
                if(doc.exists) document.getElementById('setting-delivery').value = doc.data().deliveryCharge || 0;
            });

            db.collection('coupons').onSnapshot(snap => {
                const coupons = snap.docs.map(d => ({id: d.id, ...d.data()}));
                document.getElementById('active-coupons').innerHTML = coupons.map(c => `
                    <span class="coupon-tag">
                        <b>${c.code}</b> 
                        <span style="font-size:0.8rem">(${c.type === 'percent' ? c.value + '%' : '₹' + c.value} off)</span>
                        <i class="fas fa-times" onclick="deleteCoupon('${c.id}')"></i>
                    </span>
                `).join('');
            });
        }
        
        async function saveDeliveryCharge() {
            const val = parseFloat(document.getElementById('setting-delivery').value) || 0;
            await db.collection('config').doc('store').set({ deliveryCharge: val }, { merge: true });
            showToast('Delivery Charge Saved');
        }

        async function addCoupon() {
            const code = document.getElementById('cp-code').value.toUpperCase().trim();
            const type = document.getElementById('cp-type').value;
            const value = parseFloat(document.getElementById('cp-value').value);
            const minOrder = parseFloat(document.getElementById('cp-min').value) || 0;
            const expiry = document.getElementById('cp-expiry').value;

            if(!code || !value || !expiry) return showToast('Please fill all fields');

            await db.collection('coupons').add({ code, type, value, minOrder, expiry });
            document.getElementById('cp-code').value = '';
            showToast('Coupon Created');
        }

        async function deleteCoupon(id) {
            if(confirm('Delete this coupon?')) await db.collection('coupons').doc(id).delete();
        }

        // --- UTILS ---
        function switchView(view) {
            activeView = view;
            ['dash', 'tracking', 'products', 'categories', 'orders', 'users', 'settings'].forEach(v => {
                document.getElementById(`view-${v}`).classList.add('hidden');
            });
            document.getElementById(`view-${view}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            updateOrderNotification();

            if(window.innerWidth <= 900) toggleSidebar();
        }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>